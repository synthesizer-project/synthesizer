name: Single Precision Tests

on:
  pull_request:
    branches: ["main"]
  push:
    branches: ["main"]

jobs:
  test-single-precision:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python 3.10
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"
          
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install wheel
          # Install optional dependencies for tests
          pip install cython
          # Install package with SINGLE_PRECISION=1
          SINGLE_PRECISION=1 pip install .[test,bluetides,eagle]
          
          # Optional dependencies for tests
          pip install "illustris_python @ git+https://github.com/illustristng/illustris_python.git@master"
          pip install "git+https://github.com/WillJRoper/dense_basis.git@numpy-updates"
          pip install pytest-xdist
          
          # Check build log
          cat build_synth.log

      - name: Download test data
        run: |
          synthesizer-download --test-grids --dust-grid --all-sim-data --instruments EuclidNISP

      - name: Verify Single Precision
        run: |
          # Verify that the package reports it is in single precision mode
          python -c "from synthesizer import precision; assert precision.get_precision() == 'float32', f'Expected float32, got {precision.get_precision()}'"
          # Run the specific precision tests
          pytest tests/test_precision.py

      - name: Run Core Tests
        run: |
          # Run the main test suite with single precision
          # Run the full pytest suite in tests/
          pytest -n auto tests/
